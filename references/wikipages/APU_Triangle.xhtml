<?xml version="1.0" ?><!DOCTYPE html  PUBLIC '-//W3C//DTD XHTML 1.0 Transitional//EN'  'http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd'><html xmlns="http://www.w3.org/1999/xhtml"><head><title>APU Triangle</title>
<meta content="width=display-width" name="viewport"/>
<link href="w.css" rel="stylesheet" type="text/css"/>
<script src="w.js" type="text/javascript"/>
</head><body><h1>APU Triangle</h1><div class="article">
<p>The <a href="APU.xhtml" title="APU">NES APU</a> triangle channel generates a pseudo-triangle wave. It has no volume control; the waveform is either cycling or suspended. It includes a <i>linear counter</i>, an extra duration timer of higher accuracy than the <a href="APU_Length_Counter.xhtml" title="APU Length Counter">length counter</a>.
</p><p>The triangle channel contains the following: <a class="mw-redirect" href="APU.xhtml" title="APU Misc">timer</a>, <a href="APU_Length_Counter.xhtml" title="APU Length Counter">length counter</a>, linear counter, linear counter reload flag, control flag, <a class="mw-redirect" href="APU.xhtml" title="APU Misc">sequencer</a>.
</p>
<pre>
      Linear Counter   Length Counter
            |                |
            v                v
Timer ---&gt; Gate ----------&gt; Gate ---&gt; Sequencer ---&gt; (to mixer)
</pre>
<table border="1">
<tr>
<td> <b>$4008</b> </td>
<td> <tt>CRRR.RRRR</tt> </td>
<td> <b>Linear counter</b> setup (write)
</td></tr>
<tr>
<td> bit 7 </td>
<td> <tt>C---.----</tt> </td>
<td> Control flag (this bit is also the <a href="APU_Length_Counter.xhtml" title="APU Length Counter">length counter halt flag</a>)
</td></tr>
<tr>
<td> bits 6-0 </td>
<td> <tt>-RRR RRRR</tt> </td>
<td> Counter reload value
</td></tr>
<tr>
<td colspan="3">  
</td></tr>
<tr>
<td> <b>$400A</b> </td>
<td> <tt>LLLL.LLLL</tt> </td>
<td> <b><a class="mw-redirect" href="APU.xhtml" title="APU Misc">Timer low</a></b> (write)
</td></tr>
<tr>
<td> bits 7-0 </td>
<td> <tt>LLLL LLLL</tt> </td>
<td> Timer low 8 bits
</td></tr>
<tr>
<td colspan="3">  
</td></tr>
<tr>
<td> <b>$400B</b> </td>
<td> <tt>llll.lHHH</tt> </td>
<td> <b><a href="APU_Length_Counter.xhtml" title="APU Length Counter">Length counter load</a></b> and <b><a class="mw-redirect" href="APU.xhtml" title="APU Misc">timer high</a></b> (write)
</td></tr>
<tr>
<td> bits 2-0 </td>
<td> <tt>---- -HHH</tt> </td>
<td> Timer high 3 bits
</td></tr>
<tr>
<td colspan="2"> Side effects </td>
<td> Sets the linear counter reload flag
</td></tr></table>
<p>The sequencer is clocked by a <a class="mw-redirect" href="APU.xhtml" title="APU Misc">timer</a> whose period is the 11-bit value (<tt>%HHH.LLLLLLLL</tt>) formed by timer high and timer low, <i>plus one</i>. Given <i>t = HHHLLLLLLLL</i>,
the timer counts <i>t, t-1, ..., 0, t, t-1, ...</i>, clocking the waveform generator when it goes from 0 to t.
Unlike the <a href="APU_Pulse.xhtml" title="APU Pulse">pulse</a> channels, this timer ticks at the rate of the CPU clock rather than the APU (CPU/2) clock.
So given the following:
</p>
<ul><li>f<sub>CPU</sub> = the <a href="Clock_rate.xhtml" title="Clock rate">clock rate</a> of the CPU</li>
<li>tval = the value written to the timer high and low registers</li>
<li>f = the frequency of the wave generated by this channel</li></ul>
<p>The following relationships hold:
</p>
<ul><li>f = f<sub>CPU</sub>/(32*(tval + 1))</li>
<li>tval = f<sub>CPU</sub>/(32*f) - 1</li></ul>
<p>Unlike the <a href="APU_Pulse.xhtml" title="APU Pulse">pulse</a> channels, the triangle channel supports frequencies up to the maximum frequency the timer will allow, meaning frequencies up to f<sub>CPU</sub>/32 (about 55.9 kHz for NTSC)
are possible - far above the audible range. Some games, e.g. Mega Man 2, &quot;silence&quot; the triangle channel by setting the timer to zero, which produces a popping sound when an audible frequency is resumed, easily heard e.g. in Crash Man's stage. At the expense of accuracy, these can be eliminated in an emulator e.g. by halting the triangle channel when an ultrasonic frequency is set (a timer value less than 2).
</p><p>When the <a href="APU_Frame_Counter.xhtml" title="APU Frame Counter">frame counter</a> generates a linear counter clock, the following actions occur in order:
</p>
<ol><li> If the linear counter reload flag is set, the linear counter is reloaded with the counter reload value, otherwise if the linear counter is non-zero, it is decremented.</li>
<li> If the control flag is clear, the linear counter reload flag is cleared.</li></ol>
<p>The sequencer is clocked by the timer as long as both the linear counter and the <a href="APU_Length_Counter.xhtml" title="APU Length Counter">length counter</a> are nonzero.
</p><p>The sequencer sends the following looping 32-step sequence of values to the <a href="APU_Mixer.xhtml" title="APU Mixer">mixer</a>:
</p>
<pre>
15, 14, 13, 12, 11, 10,  9,  8,  7,  6,  5,  4,  3,  2,  1,  0
 0,  1,  2,  3,  4,  5,  6,  7,  8,  9, 10, 11, 12, 13, 14, 15
</pre>
<p>At the lowest two <a class="mw-redirect" href="APU.xhtml" title="APU Misc">timer</a> periods ($400B = 0 and $400A = 0 or 1), the resulting frequency is so high (over 20 kHz) that the <a href="APU_Mixer.xhtml" title="APU Mixer">mixer</a> effectively receives a value half way between 7 and 8.<br/>
<b>Note:</b> If you're using this to silence the triangle channel, be aware that this makes a popping noise, because the triangle output is basically jumping to &quot;7.5&quot;, from wherever it was before (could be 0 or 15). Mega Man 1 and 2 do this.
</p><p>If that's undesirable, then there are three other ways to silence the triangle channel:
</p>
<ul><li> Use the linear counter to control the length of the note. This may be a bit limiting, because the linear counter doesn't allow for super-long notes.</li>
<li> Use $4015 to turn off the triangle channel when it needs to be silent (don't forget to turn it back on). However, <a href="APU.xhtml#Status_.28.244015.29" title="APU">writing to $4015</a> may cause problems if you're using the DMC.</li>
<li> Use the following writes when you want to silence the triangle channel:
<ol><li> Write $00 to $4008. This sets the linear counter to 0.</li>
<li> Write to $400B. This is to reload the linear counter with that 0. Be careful, because this register contains 3 bits of the triangle channel's period. You'd either need to rewrite the same value to this register, or write $07 to change the period to something low pitched and unnoticable.</li>
<li> Write to $4017 with bit 7 set. This will immediately clock the linear counter, reloading it, and silencing the triangle channel. This step is optional, but if you don't do this, there will be a random delay before the triangle channel is actually silenced, which is why it's important to pay attention to what you write to $400B in the previous step.
<ul><li> If you want to use the things that depend on the frame counter, you can simply write to $4017 every frame at the end of your music routine, instead of compulsively writing to $4017 only when you want to silence the triangle channel. This will keep the frame counter's sequencer consistent.</li></ul></li></ol></li></ul>

<!-- 
NewPP limit report
CPU time usage: 0.040 seconds
Real time usage: 0.041 seconds
Preprocessor visited node count: 7/1000000
Preprocessor generated node count: 44/1000000
Post‐expand include size: 0/2097152 bytes
Template argument size: 0/2097152 bytes
Highest expansion depth: 2/40
Expensive parser function count: 0/100
-->

<!-- Saved in parser cache with key nesdev_wiki-mw1_:pcache:idhash:177-1!*!0!*!*!*!* and timestamp 20160208224732 and revision id 8960
 -->
<p class="categories">Categories: <a href="Category_APU.xhtml">APU</a></p></div></body></html>